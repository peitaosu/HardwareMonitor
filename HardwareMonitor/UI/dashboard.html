<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hardware Monitor</title>
    <link rel="stylesheet" href="tabler/dist/css/tabler.min.css">
    <link rel="stylesheet" href="tabler/dist/css/tabler-flags.min.css">
    <link rel="stylesheet" href="tabler-icons/tabler-icons.min.css">
    <link rel="stylesheet" href="tabler/dist/libs/apexcharts/dist/apexcharts.css">
    <link rel="stylesheet" href="css/custom.css">
</head>
<body data-bs-theme="dark">
    <div class="layout-fluid">
        <div class="page">
            <header id="main_navbar" class="navbar navbar-expand-md sticky-top d-print-none">
                <div class="container-xl">
                    <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                        <i class="ti ti-heart-rate-monitor"></i> Hardware Monitor
                    </h1>
                    <div class="navbar-nav flex-row order-md-last">
                        <div class="nav-item">
                            <a id="dialog_mini" href="#" class="nav-link d-flex lh-1 text-reset p-0">
                                <i class="ti ti-arrow-bar-down"></i>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a id="dialog_center" href="#" class="nav-link d-flex lh-1 text-reset p-0">
                                <i class="ti ti-window-minimize"></i>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a id="dialog_max" href="#" class="nav-link d-flex lh-1 text-reset p-0">
                                <i class="ti ti-window-maximize"></i>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a id="dialog_x" href="#" class="nav-link d-flex lh-1 text-reset p-0">
                                <i class="ti ti-square-x"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </header>
            <div class="page-wrapper">
                <div class="page-body">
                    <div class="container-xl">
                        <div class="row row-deck row-cards">
                            <!--Machine-->
                            <div class="col-12 col-md-4 col-xl-4">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-auto">
                                                <span class="text-white avatar">
                                                    <img src="image/machine.svg" />
                                                </span>
                                            </div>
                                            <div class="col">
                                                <div class="text-secondary">
                                                    Machine
                                                </div>
                                                <div class="font-weight-medium">
                                                    <span id="name_machine"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--IP-->
                            <div class="col-12 col-md-4 col-xl-4">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-auto">
                                                <span class="text-white avatar">
                                                    <img src="image/ip.svg" />
                                                </span>
                                            </div>
                                            <div class="col">
                                                <div class="text-secondary">
                                                    IPv4
                                                </div>
                                                <div class="font-weight-medium">
                                                    <span id="name_ipv4"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--Motherboard-->
                            <div class="col-12 col-md-4 col-xl-4">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-auto">
                                                <span class="text-white avatar">
                                                    <img src="image/motherboard.svg" />
                                                </span>
                                            </div>
                                            <div class="col">
                                                <div class="text-secondary">
                                                    Motherboard
                                                </div>
                                                <div class="font-weight-medium">
                                                    <span id="name_motherboard"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--CPU-->
                            <div class="col-12 col-md-2 col-xl-2">
                                <div class="card">
                                    <div class="card-stamp">
                                        <div class="card-stamp-icon">
                                            <img src="image/cpu.svg" />
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="col">
                                            <div class="text-secondary">
                                                CPU
                                            </div>
                                            <div class="font-weight-medium">
                                                <span id="name_cpu"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="chart-cpu-overall">
                                    </div>
                                </div>
                            </div>
                            <!--RAM-->
                            <div class="col-12 col-md-2 col-xl-2">
                                <div class="card">
                                    <div class="card-stamp">
                                        <div class="card-stamp-icon">
                                            <img src="image/ram.svg" />
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="col">
                                            <div class="text-secondary">
                                                RAM
                                            </div>
                                            <div class="font-weight-medium">
                                                <span id="name_ram"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="chart-ram-used">
                                    </div>
                                </div>
                            </div>
                            <!--GPU-->
                            <div class="col-12 col-md-2 col-xl-2">
                                <div class="card">
                                    <div class="card-stamp">
                                        <div class="card-stamp-icon">
                                            <img src="image/gpu.svg" />
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="col">
                                            <div class="text-secondary">
                                                GPU
                                            </div>
                                            <div class="font-weight-medium">
                                                <span id="name_gpu"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="chart-gpu-overall">
                                    </div>
                                </div>
                            </div>
                            <!--Network-->
                            <div class="col-12 col-md-2 col-xl-2">
                                <div class="card">
                                    <div class="card-stamp">
                                        <div class="card-stamp-icon">
                                            <img src="image/port.svg" />
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="col">
                                            <div class="text-secondary">
                                                Network
                                            </div>
                                        </div>
                                    </div>
                                    <div id="chart-net-overall">
                                    </div>
                                </div>
                            </div>
                            <!--Storage Drive-->
                            <div class="col-12 col-md-2 col-xl-2">
                                <div class="card">
                                    <div class="card-stamp">
                                        <div class="card-stamp-icon">
                                            <img src="image/hdd.svg" />
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="col">
                                            <div class="text-secondary">
                                                Storage
                                            </div>
                                        </div>
                                    </div>
                                    <div id="chart-dd-usage">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="tabler/dist/js/tabler.min.js"></script>
    <script src="tabler/dist/libs/apexcharts/dist/apexcharts.min.js"></script>
    <script>
        "use strict";
        var machine_id = 0;
        var CPU_Sensors = {};
        var RAM_Sensors = [];
        var GPU_Sensors = {};
        var NET_Sensors = {};
        var STO_Sensors = {};
        function StartMonitor() {
            window.chrome.webview.postMessage({
                "Type": "GET",
                "Source": "Dashboard",
                "Target": "Hardware",
                "Message": {
                    "MachineID": machine_id,
                    "Event": "Start"
                }
            });
        }
        function GetHardware() {
            window.chrome.webview.postMessage({
                "Type": "GET",
                "Source": "Dashboard",
                "Target": "Hardware",
                "Message": {
                    "MachineID": machine_id,
                    "Event": "Fetch",
                    "Last": 10
                }
            });
        }
        function GetMachine() {
            window.chrome.webview.postMessage({
                "Type": "GET",
                "Source": "Dashboard",
                "Target": "Machine",
                "Message": {}
            });
        }
        function SendClickEvent(target, key = "left", double = false) {
            window.chrome.webview.postMessage({
                "Type": "CLICK",
                "Source": "Dashboard",
                "Target": target,
                "Message": {
                    "Double": double,
                    "Key": key
                }
            });
        }
        function MoveWindow(event) {
            window.chrome.webview.postMessage({
                "Type": "MOUSEMOVE",
                "Target": "body",
                "Message": {
                    "X": event.offsetX,
                    "Y": event.offsetY
                }
            });
        }
        GetMachine();
        StartMonitor();
        setInterval(GetHardware, 5000);
        document.querySelectorAll(".nav-link").forEach(element => {
            element.addEventListener("click", event => {
                var target = event.currentTarget;
                switch (target.id) {
                    case "dialog_mini":
                        SendClickEvent("Min");
                        break;
                    case "dialog_center":
                        SendClickEvent("Center");
                        break;
                    case "dialog_max":
                        SendClickEvent("Max");
                        break;
                    case "dialog_x":
                        SendClickEvent("X");
                        break;
                    default:
                        break;
                }
            });
        });
        const main_navbar = document.querySelector("#main_navbar");
        const body = document.querySelector("body");
        main_navbar.addEventListener("mousedown", () => {
            window.chrome.webview.postMessage({
                "Type": "MOUSEDOWN",
                "Target": main_navbar.id,
            });
            body.addEventListener("mousemove", MoveWindow);
        });
        main_navbar.addEventListener("mouseup", () => {
            window.chrome.webview.postMessage({
                "Type": "MOUSEUP",
                "Target": main_navbar.id,
            });
            body.removeEventListener("mousemove", MoveWindow);
        });
        main_navbar.addEventListener("dblclick", () => {
            SendClickEvent("Nav", "left", true);
        });
        var chart_cpu_overall_options = {
            chart: {
                type: "area",
                fontFamily: 'inherit',
                height: 150,
                toolbar: {
                    show: false,
                },
                sparkline: {
                    enabled: true
                },
                animations: {
                    enabled: false
                },
                toolbar: {
                    show: false
                },
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: "straight"
            },
            markers: {
                size: 0
            },
            tooltip: {
                theme: 'dark'
            },
            xaxis: {
                labels: {
                    padding: 0,
                },
                tooltip: {
                    enabled: false
                },
                axisBorder: {
                    show: false,
                },
                type: 'datetime',
            },
            yaxis: {
                max: 100,
                min: 0
            },
            colors: [tabler.getColor("green"), tabler.getColor("blue"), tabler.getColor("red")],
            legend: {
                show: false
            },
            series: [{ data: [] }],
            labels: [],
        };
        var chart_gpu_overall_options = {...chart_cpu_overall_options};
        var chart_ram_used_options = {
            series: [],
            chart: {
                type: "donut",
                fontFamily: 'inherit',
                height: 150,
                sparkline: {
                    enabled: true
                },
                animations: {
                    enabled: false
                },
            },
            fill: {
                opacity: 1,
            },
            labels: ["Used", "Available"],
            tooltip: {
                theme: 'dark'
            },
            grid: {
                strokeDashArray: 4,
                padding: {
                    bottom: 30,
                }
            },
            legend: {
                show: false
            },
            tooltip: {
                fillSeriesColor: false
            },
        };
        var chart_net_overall_options = {
            chart: {
                type: "bar",
                fontFamily: 'inherit',
                height: 150,
                parentHeightOffset: 0,
                toolbar: {
                    show: false,
                },
                sparkline: {
                    enabled: true
                },
                animations: {
                    enabled: false
                },
            },
            dataLabels: {
                enabled: true,
            },
            fill: {
                opacity: 1,
            },
            series: [],
            tooltip: {
                theme: 'dark'
            },
            grid: {
                show: false,
                padding: {
                    bottom: 0,
                }
            },
            xaxis: {
                labels: {
                    show: false,
                }
            },
            labels: [],
            colors: [tabler.getColor("blue"), tabler.getColor("green")],
            legend: {
                show: false,
            },
        }
        console.log(chart_net_overall_options);
        var chart_dd_usage_options = {...chart_net_overall_options};
        var chart_cpu_overall = new ApexCharts(document.getElementById('chart-cpu-overall'), chart_cpu_overall_options);
        chart_cpu_overall.render();
        var chart_ram_used = new ApexCharts(document.getElementById('chart-ram-used'), chart_ram_used_options);
        chart_ram_used.render();
        var chart_gpu_overall = new ApexCharts(document.getElementById('chart-gpu-overall'), chart_gpu_overall_options);
        chart_gpu_overall.render();
        var chart_net_overall = new ApexCharts(document.getElementById('chart-net-overall'), chart_net_overall_options);
        chart_net_overall.render();
        var chart_dd_usage = new ApexCharts(document.getElementById('chart-dd-usage'), chart_dd_usage_options);
        chart_dd_usage.render();
        async function update_chart_cpu_overall() {
            return new Promise((resolve, reject) => {
                const chart_data = [];
                for (const [type, data] of Object.entries(CPU_Sensors["Load"])) {
                    chart_data.push({
                        name: type,
                        data: data
                    });
                }
                chart_cpu_overall.updateSeries(chart_data, true);
                chart_cpu_overall.updateOptions({ labels: CPU_Sensors["Timeline"] });
            });
        }
        async function update_chart_ram_used() {
            return new Promise((resolve, reject) => {
                chart_ram_used.updateSeries(RAM_Sensors, true);
            });
        }
        async function update_chart_gpu_overall() {
            return new Promise((resolve, reject) => {
                const chart_data = [];
                for (const [type, data] of Object.entries(GPU_Sensors["Load"])) {
                    chart_data.push({
                        name: type,
                        data: data
                    });
                }
                chart_gpu_overall.updateSeries(chart_data, true);
                chart_gpu_overall.updateOptions({ labels: GPU_Sensors["Timeline"] });
            });
        }
        async function update_chart_net_overall() {
            return new Promise((resolve, reject) => {
                const chart_data = [];
                for (const [type, data] of Object.entries(NET_Sensors["Throughput"])) {
                    chart_data.push({
                        name: type,
                        data: data
                    });
                }
                chart_net_overall.updateSeries(chart_data, true);
                chart_net_overall.updateOptions({
                    
                    labels: NET_Sensors["Name"]
                });
            });
        }
        async function update_chart_dd_usage() {
            return new Promise((resolve, reject) => {
                const chart_data = [];
                for (const [type, data] of Object.entries(STO_Sensors["Load"])) {
                    chart_data.push({
                        name: type,
                        data: data
                    });
                }
                chart_dd_usage.updateSeries(chart_data, true);
                chart_dd_usage.updateOptions({
                    chart: { stacked: true },
                    labels: STO_Sensors["Name"]
                });
            });
        }
        window.chrome.webview.addEventListener("message", event => {
            var data = event.data;
            switch (data.Type) {
                case "Machine":
                    document.querySelector("#name_machine").innerHTML = data.Data.MachineName;
                    document.querySelector("#name_ipv4").innerHTML = data.Data.URI;
                    machine_id = data.Machine;
                    break;
                case "Hardware":
                    console.log(data.Data);
                    CPU_Sensors = {
                        "Load": {
                            "Utilization": [],
                            "Max": [],
                        },
                        "Temperature": {
                            "Value": [],
                            "Max": []
                        },
                        "Timeline": []
                    };
                    RAM_Sensors = [];
                    GPU_Sensors = {
                        "Load": {
                            "Utilization": [],
                            "Max": [],
                        },
                        "Temperature": {
                            "Value": [],
                            "Max": []
                        },
                        "Timeline": []
                    };
                    NET_Sensors = {
                        "Throughput": {
                            "Upload": [],
                            "Download": []
                        },
                        "Name": [],
                        "Id": []
                    }
                    STO_Sensors = {
                        "Throughput": {
                            "Read": [],
                            "Write": []
                        },
                        "Load": {
                            "Used": [],
                            "Max": []
                        },
                        "Name": [],
                        "Id": []
                    }
                    data.Data.forEach(hardware => {
                        switch (hardware.Hardware) {
                            case "Motherboard":
                                document.querySelector("#name_motherboard").innerHTML = hardware.Name;
                                break;
                            case "Cpu":
                                CPU_Sensors["Timeline"].push(hardware.Timestamp);
                                document.querySelector("#name_cpu").innerHTML = hardware.Name;
                                for (const [id, sensor] of Object.entries(JSON.parse(hardware.Sensors)["Load"])) {
                                    for (const [name, value] of Object.entries(sensor)) {
                                        if (name != "CPU Total") continue;
                                        CPU_Sensors["Load"]["Utilization"].push(value.Value);
                                        CPU_Sensors["Load"]["Max"].push(value.Max);
                                    }
                                }
                                for (const [id, sensor] of Object.entries(JSON.parse(hardware.Sensors)["Temperature"])) {
                                    for (const [name, value] of Object.entries(sensor)) {
                                        if (name != "Core (Tctl/Tdie)") continue;
                                        CPU_Sensors["Temperature"]["Value"].push(value.Value);
                                        CPU_Sensors["Temperature"]["Max"].push(value.Max);
                                    }
                                }
                                break;
                            case "Memory":
                                document.querySelector("#name_ram").innerHTML = hardware.Name;
                                var used = 0.0;
                                var available = 0.0;
                                for (const [id, sensor] of Object.entries(JSON.parse(hardware.Sensors)["Data"])) {
                                    for (const [name, value] of Object.entries(sensor)) {
                                        if (name == "Memory Used") {
                                            used = value.Value;
                                        } else if (name == "Memory Available") {
                                            available = value.Value;
                                        }
                                    }
                                }
                                RAM_Sensors = [used, available];
                                break;
                            case "GpuAmd":
                            case "GpuNvidia":
                                document.querySelector("#name_gpu").innerHTML = hardware.Name;
                                GPU_Sensors["Timeline"].push(hardware.Timestamp);
                                for (const [id, sensor] of Object.entries(JSON.parse(hardware.Sensors)["Load"])) {
                                    for (const [name, value] of Object.entries(sensor)) {
                                        if (name != "GPU Core") continue;
                                        GPU_Sensors["Load"]["Utilization"].push(value.Value);
                                        GPU_Sensors["Load"]["Max"].push(value.Max);
                                    }
                                }
                                break;
                            case "Network":
                                if (NET_Sensors["Id"].includes(hardware.Identifier)) break;
                                NET_Sensors["Id"].push(hardware.Identifier);
                                var has_speed = false;
                                for (const [id, sensor] of Object.entries(JSON.parse(hardware.Sensors)["Throughput"])) {
                                    for (const [name, value] of Object.entries(sensor)) {
                                        if (value.Value < 1 && !has_speed) {
                                            continue;
                                        } else {
                                            has_speed = true;
                                        }
                                        if (name == "Download Speed") {
                                            NET_Sensors["Throughput"]["Download"].push(parseInt(value.Value / 1000));
                                        } else if (name == "Upload Speed") {
                                            NET_Sensors["Throughput"]["Upload"].push(parseInt(value.Value / 1000));
                                        }
                                    }
                                }
                                if (has_speed) {
                                    NET_Sensors["Name"].push(hardware.Name);
                                }
                                break;
                            case "Storage":
                                if (STO_Sensors["Id"].includes(hardware.Identifier)) break;
                                STO_Sensors["Id"].push(hardware.Identifier);
                                for (const [id, sensor] of Object.entries(JSON.parse(hardware.Sensors)["Throughput"])) {
                                    for (const [name, value] of Object.entries(sensor)) {
                                        if (name == "Read Rate") {
                                            STO_Sensors["Throughput"]["Read"].push(parseInt(value.Value));
                                        } else if (name == "Write Speed") {
                                            STO_Sensors["Throughput"]["Write"].push(parseInt(value.Value));
                                        }
                                    }
                                }
                                for (const [id, sensor] of Object.entries(JSON.parse(hardware.Sensors)["Load"])) {
                                    for (const [name, value] of Object.entries(sensor)) {
                                        if (name != "Used Space") continue;
                                        STO_Sensors["Load"]["Used"].push(parseInt(value.Value));
                                        STO_Sensors["Load"]["Max"].push(100 - parseInt(value.Value));
                                    }
                                }
                                STO_Sensors["Name"].push(hardware.Name);
                                break;
                            default:
                                break;
                        }
                    });
                    update_chart_cpu_overall();
                    update_chart_ram_used();
                    update_chart_gpu_overall();
                    update_chart_net_overall();
                    update_chart_dd_usage();
                    break;
                default:
                    break;
            }
        });
    </script>
</body>
</html>